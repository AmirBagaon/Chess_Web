<html>
  <head>
    {% load static %}
    <title>Chess engine</title>
        
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- chessjs -->
    <script src="{% static 'main/js/chess.js' %}"></script>
    
    <!-- chessboardjs -->
    <link rel="stylesheet" href="{% static 'main/css/chessboard-1.0.0.min.css' %}">
    <script src="{% static 'main/js/chessboard-1.0.0.min.js' %}"></script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <div class="card mt-5">
            <div class="card-body">
              <!-- chess board view -->
              <div id="chess_board" class="mx-auto" style="width: 600px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <h2 class="text-center" id="game_result">Running</h2>
    </div>
    <div>
        <form  id="friend_form" action="" method="post">{% csrf_token %} </form>
    </div>
  </body>
</html>


<script>
    var url = "{% static 'main/css/chessboard-1.0.0.min.css' %}";
</script>
<script>

// --- Begin Example JS --------------------------------------------------------
// NOTE: this example uses the chess.js library:
// https://github.com/jhlywa/chess.js

var board = null
var game = new Chess()
console.log("{% static 'main/css/chessboard-1.0.0.min.css' %}")

function sendForm() {
    $('#friend_form').submit();
}

function makeRandomMove () {
  var possibleMoves = game.moves()

  // exit if the game is over
  if (game.game_over()) {
    console.log("Here")
    game_result_div = document.getElementById("game_result")
    console.log("Here2")
    if (game.in_checkmate()) {
      game_result_div.innerHTML = "Checkmate"
    }
    else {
      game_result_div.innerHTML = "Draw"
    }

    
    return
  }

  var randomIdx = Math.floor(Math.random() * possibleMoves.length)
  game.move(possibleMoves[randomIdx])
  board.position(game.fen())

  console.log(game.pgn())
  console.log(game.fen())
//   window.setTimeout(makeRandomMove, 100)
    window.setTimeout(makeMove, 500)

}
function makeMove() {
    sendForm()
    if (game.game_over()) {
    console.log("Here")
    game_result_div = document.getElementById("game_result")
    console.log("Here2")
    if (game.in_checkmate()) {
      game_result_div.innerHTML = "Checkmate"
    }
    else {
      game_result_div.innerHTML = "Draw"
    }

    
    return
  }
//   window.setTimeout(makeMove, 500)
}

board = Chessboard('chess_board', 'start')

window.setTimeout(makeMove, 500)
</script>

<script>
    
$(document).ready(function() {

//Function to send POST with any desired data
$('#friend_form').submit(function() { // On form submit event

    console.log("before sending")
    var fen = game.fen()
    console.log(fen)
    //The form contains the csrf token
    var data = $(this).serializeArray(); // convert form to array
    data.push({name: "input_area", value:  fen});

    $.ajax({ // create an AJAX call...
        data: $.param(data), // get the form data
        type: $(this).attr('method'), // GET or POST
        url: "/temp", // the file to call
        success: function(response) { // on success..
            console.log("after sending")
            console.log(response.message)
            game.move(response.message, { sloppy: true })
            board.position(game.fen())
            console.log(game.fen())
            console.log("success")
            // $('#output_area').val(response.message); // update the DIV
        },
        error: function(e, x, r) { // on error..
            console.log("error")
            // $('#output_area').html(e); // update the DIV
        }
    });
    return false;
});
});
</script>
